@model IEnumerable<Book>
@{
    ViewData["Title"] = "Home Page";
}

@section styles{
    <link href="~/lib/owl/dist/assets/owl.carousel.min.css" rel="stylesheet" />
    <link href="~/lib/owl/dist/assets/owl.theme.default.min.css" rel="stylesheet" />
}

<div class="row">
    <div class="col-12">
        <div class="search float-left">
            <div class="ui category search">
                <div class="ui icon input">
                    <input class="prompt" id="book-search" type="text" placeholder="Search books...">
                    <i class="search icon"></i>
                </div>
                <div class="results"></div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-5">
    <div class="col-12" style="height: 400px;">
        <div class="owl-carousel">
            @foreach (var slide in Model)
            {
                <div class="row">
                    <div class="col-8">
                        <h2>@slide.Title</h2>
                        @foreach (var author in slide.Authors)
                        {
                            <a asp-controller="author" asp-action="details" asp-route-id="@author.Author.Id"
                               class="text-primary ml-1">@author.Author.Fullname</a>
                        }
                        <br />
                        @foreach (var cat in slide.Categories)
                        {
                            <a asp-controller="category" asp-action="details" asp-route-id="@cat.Category.Id"
                               class="btn btn-outline-secondary mt-3">@cat.Category.Name</a>
                        }
                        <p class="text-secondary mt-2">
                            @(slide.Description?.Length > 300 ?
                                                      slide.Description.Substring(0, 200) + "..." : slide.Description)
                        </p>
                        <a asp-controller="book" asp-action="details" asp-route-id="@slide.Id"
                           class="btn btn-outline-success position-absolute" style="bottom: 30px; right: 20px;">See details</a>
                    </div>
                    <div class="col-4">
                        <img src="@slide.DefaultImage" class="img-thumbnail" style="height: 300px; object-fit: contain;" />
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section scripts{
    <script src="~/lib/owl/dist/owl.carousel.min.js"></script>
    <script>
        $(document).ready(function () {
            $(".owl-carousel").owlCarousel({
                loop: true,
                autoplay: true,
                items: 1,
                autoplayHoverPause: true
            });

            $(document).on("keyup", "#book-search", function () {
                $('.ui.search')
                    .search({
                        type: 'category',
                        minCharacters: 1,
                        apiSettings: {
                            onResponse: function (result) {
                                var response = {
                                    results: {}
                                };
                                // translate API response to work with search
                                $.each(result.items, function (index, item) {
                                    var category = item.category || 'Unknown';
                                    var maxResult = 6;
                                    if (index >= maxResult) {
                                        return false;
                                    }
                                    // create new category
                                    if (response.results[category] === undefined) {
                                        response.results[category] = {
                                            name: category,
                                            results: []
                                        };
                                    }
                                    // add result to category
                                    response.results[category].results.push({
                                        title: item.title,
                                        description: item.description,
                                        url: item.url,
                                        image: item.image
                                    });
                                });
                                return response;
                            },
                            url: '/search/books?q=' + $(this).val()
                        }
                    });
            });
        })
    </script>
}